import{j as n}from"./jsx-runtime-QvtbNqby.js";import{r as b}from"./index-BjzEU6Zr.js";import{i as N}from"./index-BYMUMZMs.js";import"./usePrefix-BezXHAvh.js";import{O as R,a as T}from"./index-9NatbUAG.js";import{u as D,a as M}from"./index-CfoIBI3E.js";import{S as I}from"./StatusIcon-B2CmmOh1.js";import{S as C}from"./Step-Cz-qLbwJ.js";import{c as j}from"./bucket-2-DqY0dT-j.js";import{a as v}from"./bucket-12-D9InpaXv.js";class k extends b.Component{state={hasWarning:!1,selectedStepId:null};componentDidMount(){this.selectDefaultStep(),this.getStepData({propagateWarning:!0})}componentDidUpdate(e){const{reason:t}=this.props;e.reason!==t&&t==="Succeeded"&&this.getStepData({propagateWarning:!0})}getStepData({propagateWarning:e=!1}={}){const{reason:t,selectedStepId:s,steps:r}=this.props;let l=!1;const i=D(r).map(o=>{const{name:p}=o,{exitCode:d,status:c,reason:h}=M(o);return h==="Completed"&&(l=l||d!==0),{exitCode:d,name:p,selected:s===p,stepReason:h,stepStatus:t==="TaskRunCancelled"&&c!=="terminated"?"cancelled":c}});return e&&this.setState({hasWarning:l}),i}handleClick=()=>{const{id:e,selectedRetry:t,taskRun:s}=this.props,{selectedStepId:r}=this.state;this.props.onSelect({selectedRetry:t,selectedStepId:r,selectedTaskId:e,taskRunName:s.metadata?.name})};handleStepSelected=e=>{this.setState({selectedStepId:e},()=>{this.handleClick()})};handleTaskSelected=e=>{e?.preventDefault(),this.setState({selectedStepId:null},()=>{this.handleClick()})};selectDefaultStep(){const{expanded:e,selectDefaultStep:t,selectedStepId:s,steps:r}=this.props;if(t&&e&&!s){const l=r.find(o=>o.terminated?.reason==="Error"||!o.terminated),{name:i}=l||r[0]||{};this.handleStepSelected(i)}}render(){const{displayName:e,expanded:t,intl:s,onRetryChange:r,reason:l,selectedRetry:i,selectedStepId:o,succeeded:p,taskRun:d}=this.props,{hasWarning:c}=this.state,h=t?null:n.jsx(j,{size:20,className:"tkn--task--expand-icon"});let u,m;return(i||d.status?.retriesStatus)&&(m=s.formatMessage({id:"dashboard.pipelineRun.retries.view",defaultMessage:"View retries"}),i==="0"?u=s.formatMessage({id:"dashboard.pipelineRun.pipelineTaskName.firstAttempt",defaultMessage:"{pipelineTaskName} (first attempt)"},{pipelineTaskName:e}):u=s.formatMessage({id:"dashboard.pipelineRun.pipelineTaskName.retry",defaultMessage:"{pipelineTaskName} (retry {retryNumber, number})"},{pipelineTaskName:e,retryNumber:i||d.status.retriesStatus.length})),n.jsxs("li",{className:"tkn--task","data-active":t||void 0,"data-has-warning":c,"data-reason":l,"data-succeeded":p,"data-selected":t&&!o||void 0,children:[n.jsxs("span",{className:"tkn--task-link",tabIndex:0,title:u||e,onClick:this.handleTaskSelected,onKeyUp:a=>a.key==="Enter"&&this.handleTaskSelected(a),role:"button",children:[n.jsx(I,{DefaultIcon:a=>n.jsx(v,{size:20,...a}),hasWarning:c,reason:l,status:p}),n.jsx("span",{className:"tkn--task-link--name",children:u||e}),t&&d.status?.retriesStatus?n.jsx(R,{"aria-label":m,iconDescription:m,menuOptionsClass:"tkn--task--retries-menu-options",selectorPrimaryFocus:"button:not([disabled])",size:"sm",title:m,children:d.status.retriesStatus.map((a,f)=>({id:f,text:f===0?s.formatMessage({id:"dashboard.pipelineRun.retries.viewFirstAttempt",defaultMessage:"View first attempt"}):s.formatMessage({id:"dashboard.pipelineRun.retries.viewRetry",defaultMessage:"View retry {retryNumber, number}"},{retryNumber:f})})).concat([{id:"",text:s.formatMessage({id:"dashboard.pipelineRun.retries.viewLatestRetry",defaultMessage:"View latest retry"})}]).map(a=>n.jsx(T,{disabled:`${a.id}`===i,itemText:a.text,onClick:()=>r(a.id),requireTitle:!0},a.text))}):null,h]}),t&&n.jsx("ol",{className:"tkn--step-list",children:this.getStepData().map(a=>{const{exitCode:f,name:S,selected:g,stepReason:x,stepStatus:y}=a;return n.jsx(C,{exitCode:f,id:S,onSelect:this.handleStepSelected,reason:x,selected:g,status:y,stepName:S},S)})})]})}}k.defaultProps={steps:[]};const A=N(k);k.__docgenInfo={description:"",methods:[{name:"getStepData",docblock:null,modifiers:[],params:[{name:"{ propagateWarning = false }",optional:!0,type:null}],returns:null},{name:"handleClick",docblock:null,modifiers:[],params:[],returns:null},{name:"handleStepSelected",docblock:null,modifiers:[],params:[{name:"selectedStepId",optional:!1,type:null}],returns:null},{name:"handleTaskSelected",docblock:null,modifiers:[],params:[{name:"event",optional:!1,type:null}],returns:null},{name:"selectDefaultStep",docblock:null,modifiers:[],params:[],returns:null}],displayName:"Task",props:{steps:{defaultValue:{value:"[]",computed:!1},required:!1}}};export{A as T};
